---
layout: post
title: JAVA添加文字和图片水印
date: 2019-01-04
category: [CS]
tags: 
---

我们在工作和生活中经常会遇到一些给图片添加图像或者文字水印的操作，如果是生活中用来装饰自己的照片呢，当然直接用 Photoshop 就可以了，而如果是工作中你需要在你的服务中用程序为图片添加水印，ImageMagick 则是一个命令行图像处理神器，它的功能非常强大，甚至很多大公司的云图像处理服务也是在 ImageMagick 的基础上加以包装然后对外提供服务的，不过我们今天就不讲 ImageMagick 了，而是说一说如何使用 java 为图片添加简单的水印。

先说添加文字水印，添加文字水印其实比图片水印复杂，为什么呢，因为添加文字水印一般可能都是要循环添加的，需要一些抽象能力和计算工作，比如如下示例（在新垣结衣小姐姐脸上打水印我的内心是拒绝的）：

<img src="/2019/01/04/JAVA添加文字和图片水印/acb12ed9-c553-4980-9bfc-67637afea576.jpg" width="30%" height="30%" alt="" align=center />

完整的代码如下：
<!--more-->

``` Java
import javax.imageio.ImageIO;
import javax.swing.JLabel;
import java.awt.AlphaComposite;
import java.awt.Color;
import java.awt.Font;
import java.awt.FontMetrics;
import java.awt.Graphics2D;
import java.awt.image.BufferedImage;
import java.io.FileInputStream;
import java.io.FileOutputStream;
import java.io.IOException;

/**
 * Created by chaihua on 2019/1/4.
 */
public void addWatermark() throws IOException {
    String originImagePath = "/Users/cc/test/origin.jpg";
    String targetImagePath = "/Users/cc/test/target.jpg";

    // 输入指定位置文件的图像
    BufferedImage bufferedImage = ImageIO.read(new FileInputStream(originImagePath));
    Graphics2D g2 = bufferedImage.createGraphics();

    // 设置颜色为黄色
    g2.setColor(Color.YELLOW);
    // 设置角度为水平顺时针旋转45度
    g2.rotate(Math.toRadians(45));
    // 设置字体为黑体、加粗、36号
    Font font = new Font("黑体", Font.BOLD, 36);
    g2.setFont(font);
    // 设置透明度
    g2.setComposite(AlphaComposite.getInstance(AlphaComposite.SRC_ATOP, 0.5f));

    // 设置要添加的水印文字
    String text = "新垣结衣";
    // 获取水印文字的长和宽
    FontMetrics fontMetrics = new JLabel().getFontMetrics(font);
    int textWidth = fontMetrics.stringWidth(text);
    int textHeight = fontMetrics.stringWidth(text);
    // 获取图像的长和宽
    int imageWidth = bufferedImage.getWidth();
    int imageHeight = bufferedImage.getHeight();
    // 设置希望的文字间的间隔
    int space = 60;
    // 获取要添加的文字水印的行数和列数
    int row = 2 * imageHeight / textHeight + space;
    int column = 2 * imageWidth / textWidth + space;

    for (int i = 0; i < row; ++i) {
        for (int j = 0; j < column; ++j) {
            g2.drawString(text, // 水印内容
                    (j - column / 3) * (space + textWidth) + i * (textWidth), // 水印的 x 轴坐标
                    (i - row / 3) * space); // 水印的 y 轴坐标
        }
    }
    g2.dispose();

    // 输出处理好的图像到指定位置文件
    FileOutputStream fileOutputStream = new FileOutputStream(targetImagePath);
    ImageIO.write(bufferedImage, "jpg", fileOutputStream);
    fileOutputStream.close();
}
```

再说添加图片水印，图片水印一般添加一个所以其实更加容易，主要是坐标位置的计算，假设我们希望在图片的中间位置添加水印，则代码片段如下：

``` Java
BufferedImage watermark = ImageIO.read(new ClassPathResource("image_watermark.jpg").getInputStream());
// 水印的 x 轴坐标
int xLocation = (bufferedImage.getWidth() - watermark.getWidth()) / 2;
// 水印的 y 轴坐标
int yLocation = (bufferedImage.getHeight() - watermark.getHeight()) / 2;
// 在图像的指定位置添加水印
g2.drawImage(watermark, xLocation, yLocation, watermark.getWidth(), watermark.getHeight(), null);
```

这里有个小坑，就是如果不是本地启动程序而是运行 jar 包的话获取图片的时候要用 resource.getInputStream()，而不是直接 resource.getFile()，否则会报```cannot be resolved to absolute file path because it does not reside in the
file system```这样的错误。

好了，现在你学会用 java 直接添加文字和图片水印了吗 :smile:

